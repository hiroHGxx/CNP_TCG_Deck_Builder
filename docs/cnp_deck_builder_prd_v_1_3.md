# CNP TCG Deck Builder — Product Requirements Document (PRD)

*Version 1.3 – 2025‑07‑30*

| Section                 | Owner | Status |
| ----------------------- | ----- | ------ |
| Strategy & Vision       | ヒロ    | ✅      |
| Functional Requirements | ヒロ    | ✅      |
| Reiki Card System       | ヒロ    | ✅ 完了  |
| Integrated UI Design    | ヒロ    | ✅ 完了  |
| Non‑functional          | ヒロ    | ✅      |

---

## 📋 Version 1.3 更新内容

### ✅ **Phase 1・2実装完了反映**
- **レイキカードシステム完全実装** - 15枚管理・推奨配分・バリデーション
- **統合UI完成** - 2カラムレイアウト・統計グラフ・折りたたみ式UI
- **統計可視化機能追加** - 色分布・BP分布・コスト分布グラフ
- **colorless除外システム** - レイキ関連表示からcolorless完全除外

### 🔄 仕様確定・最適化
- メインデッキクリアボタン追加
- フィルタオプション最適化（無色・スーパーレア除外）
- UIスペーシング改善（グラフ数値表示最適化）
- Disney Lorcana水準の統合UI実現

### 📊 実装状況
- **Phase 1**: 100%完了 ✅
- **Phase 2**: 95%完了（CardThumbnail拡張のみ残り）
- **全体進捗**: 約75%

---

## 1. プロダクト概要

**目的**

> ブラウザだけで動く CNP TCG 専用の *Deck Builder & Match Tracker* を提供し、プレイヤーがカード情報を検索しながら**メインデッキ（50枚）+ レイキデッキ（15枚）**を構築し、試合結果を記録して戦績を可視化できるようにする。

**コア価値**

1. **ワンストップ** – カード検索・メイン/レイキデッキ編成・戦績管理を一画面で。
2. **完全ルール対応** – CNP TCGの正式ルール（50+15枚、色均衡）に完全準拠。
3. **直感的操作** – 統合UIで検索→追加→調整の流れを中断なく実行。
4. **オフライン対応** – PWA とローカルキャッシュで大会会場でも快適利用。

---

## 2. スコープ

### 2.1 ✅ 実装完了機能 (Phase 1・2)

- **✅ カードデータベース**
  - JSON + 画像 (Supabase CDN) を事前ビルドでバンドル
  - Fuzzy 検索 (Fuse.js)／色・コスト・種族・レアリティフィルタ
  - 116枚のユニット・イベントカード完全対応

- **✅ レイキカードシステム（完全実装）**
  - 15枚のレイキデッキ管理（赤・青・緑・黄の4色）
  - メインデッキの色構成に応じた推奨レイキ配分アルゴリズム
  - レイキ不足/過多の警告表示・バリデーション
  - colorless完全除外システム

- **✅ 統合デッキビルダー（完全実装）**
  - 2カラムレイアウト: 左カード検索、右統合サイドバー
  - カードクリック or +ボタンでデッキ追加
  - リアルタイム統計表示（色分布・BP分布・コスト分布）
  - メインデッキ50枚 + レイキデッキ15枚の同時管理

- **✅ 統計可視化システム（新機能）**
  - 色分布グラフ（プログレスバー形式）
  - BP分布グラフ（ユニットカード限定・縦棒グラフ）
  - コスト分布グラフ（全カード対象・縦棒グラフ）
  - 折りたたみ式UI（スペース効率化）

- **✅ デッキ管理機能**
  - ローカル保存 (localStorage) 
  - メインデッキ・レイキデッキ個別クリア機能
  - デッキ名編集・統合バリデーション

### 2.2 🚧 残り実装 (Phase 2完成)

- **🔄 CardThumbnail拡張**
  - 枚数バッジ表示（1/4, 2/4形式）
  - +ボタンオーバーレイ（ホバー表示）
  - デッキ内/外の視覚的区別

### 2.3 📋 未実装機能 (Phase 3以降)

- **戦績トラッカー**
  - 試合日時・対戦相手名・使用デッキ・勝敗・メモを入力
  - IndexedDB保存・基礎統計表示

- **PWA対応**
  - オフラインアクセス、ホーム画面追加、App Icon

- **デッキ共有機能**
  - デッキエクスポート/インポート
  - URL共有機能（base64エンコード）

### 2.4 今後の拡張

- クラウド同期 (Supabase Row Level Security)
- QRコードでデッキ共有
- MetaMask連携でNFT所有カード自動フェッチ
- 対戦ログCSV/PDF エクスポート
- レイキ配分自動最適化AI

---

## 3. ターゲットユーザー

| Persona     | needs                       | pain‑points           |
| ----------- | --------------------------- | --------------------- |
| **競技プレイヤー** | メイン+レイキの最適配分を素早く検討         | 既存ツールがレイキ対応していない      |
| **新規プレイヤー** | レイキシステムを理解しながらデッキ構築        | 色均衡ルールが複雑で混乱しがち       |
| **大会主催者**   | 参加者のデッキ構成（レイキ含む）を確認したい     | レイキチェックが手動で時間がかかる     |

---

## 4. ユーザーストーリー (完成機能)

1. ✅ *検索* ― 「赤のユニットカード、BP5000以上」を素早く絞り込む。
2. ✅ *メインデッキ構築* ― カードをクリックして50枚になると警告が出る。
3. ✅ *レイキ構築* ― メインデッキの色に応じて適切な配分が提案される。
4. ✅ *色均衡確認* ― メイン・レイキの色バランスがリアルタイムで確認できる。
5. ✅ *統計可視化* ― BP分布・コスト分布が視覚的に理解できる。
6. 🔄 *保存・共有* ― ブラウザを閉じてもデッキが残り、URLで友人と共有できる。
7. 📋 *戦績入力* ― 大会終了後、対戦結果とメモを30秒以内に記録。

---

## 5. 主要機能詳細

### 5.1 ✅ 統合デッキビルダー UI (実装完了)

```
┌─────────────────────────────────────────┬───────────────────┐
│  🔍 検索…[奪取]  色🟢🔴🟡🔵  コスト0‑9     │ ┌───────────────┐ │
│  詳細フィルタ ▼                           │ │ デッキ統計      │ │
├─────────────────────────────────────────┤ │ 32/50 + 12/15   │ │
│  Card Grid (116枚, lazy‑load, responsive)         │ │ 完成度: 68%     │ │
│                                               │ └───────────────┘ │
│  ┌─────────────┐  ┌─────────────┐        │ ┌───────────────┐ │
│  │  📄 image     │  │  📄 image     │        │ │🎨色分布▼      │ │
│  │      +        │  │      +        │        │ │🟢████ 10枚   │ │
│  │ 2/4 ⓘ        │  │ 1/2 ⓘ        │        │ │🔴███  8枚    │ │
│  └─────────────┘  └─────────────┘        │ └───────────────┘ │
│                                               │ ┌───────────────┐ │
│  ┌─────────────┐  ┌─────────────┐        │ │⚔️BP分布▼     │ │
│  │  📄 image     │  │  📄 image     │        │ │     ▌▌   ▌    │ │
│  │      +        │  │      +        │        │ │  2k 3k   5k   │ │
│  │ 0/4 ⓘ        │  │ 1/4 ⓘ        │        │ └───────────────┘ │
│  └─────────────┘  └─────────────┘        │ ┌───────────────┐ │
│                                               │ │▼メインデッキ     │ │
│                                               │ │ リーリー×3 [クリア] │ │
│                                               │ │ ブレイズ×2      │ │
│                                               │ └───────────────┘ │
│                                               │ ┌───────────────┐ │
│                                               │ │▼レイキデッキ     │ │
│                                               │ │🟢🟢🟢🟢🟢      │ │
│                                               │ │🔴🔴🔴🔴 [クリア]  │ │
│                                               │ └───────────────┘ │
└─────────────────────────────────────────┴───────────────────┘
```

### 5.2 ✅ レイキカードシステム (実装完了)

#### レイキデッキ管理
- **構成**: 赤・青・緑・黄の基本レイキカード15枚
- **制限**: 各色最大15枚（単色デッキも可能）
- **推奨配分**: メインデッキの色比率に基づく自動提案アルゴリズム
- **colorless除外**: レイキ関連表示からcolorless完全除外

#### 実装済みレイキUIコンポーネント
```
┌─────────────────────────────────┐
│ レイキデッキ 12/15               │
├─────────────────────────────────┤
│ 🔴 [−] 4 [+]  🔵 [−] 3 [+]    │
│ 🟢 [−] 3 [+]  🟡 [−] 2 [+]    │
├─────────────────────────────────┤
│ 📊 詳細統計 (メインデッキ色分布)    │
│ 🔴: 8枚  🔵: 6枚              │
│ 🟢: 4枚  🟡: 2枚              │
│                                 │
│ ⚠️ バリデーション結果            │
│ • あと3枚追加してください         │
└─────────────────────────────────┘
```

### 5.3 ✅ 統計可視化システム (新機能実装完了)

#### 実装済み統計グラフ
1. **色分布グラフ**: プログレスバー形式（パーセンテージ表示）
2. **BP分布グラフ**: 縦棒グラフ（ユニットカード限定・1k-10k）
3. **コスト分布グラフ**: 縦棒グラフ（全カード対象・0-9コスト）

#### 技術実装詳細
- **折りたたみ式UI**: `useState`による表示/非表示制御
- **動的高さ**: CSS-in-JS `style={{ height: \`${height}px\` }}`
- **レスポンシブ対応**: Tailwind CSS responsive classes

### 5.4 ✅ 実装済みコンポーネント一覧

| Component           | 役割                        | 実装状況 |
| ------------------- | ------------------------- | ------- |
| `<IntegratedLayout>` | 2カラム統合レイアウト              | ✅ 完了  |
| `<ReikiManager>`    | レイキデッキ管理・配分調整            | ✅ 完了  |
| `<DeckSidebar>`     | 統合サイドバー・統計グラフ           | ✅ 完了  |
| `<FilterPanel>`     | 検索Input・色/コスト/種族フィルタ     | ✅ 完了  |
| `<CardGrid>`        | 116枚をlazy-load表示          | ✅ 完了  |
| `<CardThumbnail>`   | 画像+メタ+ツールチップ             | 🔄 拡張中 |
| `<SearchBar>`       | 検索・フレーバーテキストオプション      | ✅ 完了  |
| `useDeckStore()`    | Zustand。メイン+レイキ管理       | ✅ 完了  |
| `useReikiStore()`   | レイキ専用状態管理                | ✅ 完了  |

### 5.5 技術採用

- **フレームワーク**: Vite + React + TypeScript + Tailwind CSS
- **状態管理**: Zustand（メイン・レイキ分離管理）
- **画像**: Supabase CDN、256×356 WebP & `loading="lazy"`
- **統計グラフ**: CSS-in-JS動的高さ・Tailwind responsive
- **レイアウト**: CSS Grid + Flexbox（2カラム対応）

---

## 6. 非機能要件

| 区分           | 要件                            | 指標                   | 実装状況 |
| ------------ | ----------------------------- | -------------------- | ------- |
| **パフォーマンス**  | LCP < 2.5s (4G), JS < 200kB   | Lighthouse 90+       | 🔄 検証中 |
| **オフライン**    | 検索/デッキ編集/戦績登録が全て機能            | PWA audits PASS      | 📋 未実装 |
| **アクセシビリティ** | WCAG 2.1 AA                   | Lighthouse A11y > 90 | 🔄 改良中 |
| **セキュリティ**   | XSS/CSRF対策 (DOMPurify)       | OWASP ZAP Medium 0   | 📋 未実装 |
| **レスポンシブ**   | 320px～1920px対応             | 全デバイス完全対応        | ✅ 完了  |

---

## 7. 測定指標 (Success Metrics)

| KPI                | 目標 (90日) | 実装状況 |
| ------------------ | --------- | ------- |
| MAU                | 500+      | 📋 未測定 |
| デッキ作成完了率（メイン+レイキ） | 75%       | ✅ 測定可能 |
| レイキ配分最適化利用率      | 60%       | ✅ 測定可能 |
| 戦績入力継続率（3回以上）     | 40%       | 📋 未実装 |
| 平均LCP             | < 2s      | 🔄 検証中 |

---

## 8. 依存 & リスク

- 公式カード画像CDNの利用許諾/帯域制限
- レイキカードの仕様変更リスク（ゲームルール更新）
- 大会環境の電波状況 → オフラインPWAでカバー
- **✅ 解決済み**: レイキ機能の複雑性 → 直感的UI実現
- **新リスク**: 統計グラフの表示パフォーマンス

---

## 9. ✅ 実装完了タイムライン v1.3

| Phase                | 期間  | Deliverable                | 実装状況 |
| -------------------- | --- | -------------------------- | ------- |
| **✅ レイキ基盤実装**        | 2d  | ReikiCard型・ストア・基本UI   | 完了     |
| **✅ 統合UIリデザイン**       | 3d  | 2カラムレイアウト・コンポーネント再設計 | 完了     |
| **✅ 統計グラフ実装**        | 1d  | 色分布・BP分布・コスト分布グラフ    | 完了     |
| **🔄 CardThumbnail拡張**  | 0.5d | 枚数バッジ・+ボタン追加         | 95%     |
| **📋 デッキ管理機能拡張**      | 2d  | メイン+レイキ統合保存・読み込み     | 未着手   |
| **📋 PWA + QA**         | 2d  | Lighthouse 90+/Offline OK | 未着手   |
| **📋 公開**               | 1d  | Vercel Deploy + ドメイン    | 未着手   |

---

## 10. ✅ 技術仕様要件 (実装確定)

### 実装済みデータ構造
```typescript
interface Deck {
  name: string
  cards: Record<string, number>     // メインデッキカードID→枚数
  lastModified: string              // 更新日時
}

interface ReikiCard {
  color: 'red' | 'blue' | 'green' | 'yellow'
  count: number                     // 0-15枚
}

interface ColorDistribution {
  red: number
  blue: number
  green: number
  yellow: number
  // colorless: 除外済み（レイキ関連表示から完全除外）
}
```

### 実装済みバリデーションルール
- メインデッキ: 50枚厳守、同名カード4枚制限
- レイキデッキ: 15枚厳守、4色自由配分
- colorless除外: レイキ関連のすべての色分布からcolorless除外
- 統計計算: リアルタイム更新・エラーハンドリング完備

---

## 11. 次フェーズ計画

### Phase 2完成 (残り5%)
- **CardThumbnail拡張**: 枚数バッジ・+ボタン・デッキ内外スタイル

### Phase 3: デッキ管理拡張
- メイン+レイキ統合保存・読み込み
- デッキエクスポート/インポート
- URL共有機能

### Phase 4: 戦績管理
- 対戦記録入力・保存
- 戦績統計・可視化
- 勝率分析

### Phase 5: PWA対応
- オフライン機能
- ホーム画面追加
- パフォーマンス最適化

---

## 12. 未解決事項 / 今後検討

- レギュレーション変更（枚数制限）への動的対応
- レイキ配分AI最適化アルゴリズム
- NFT所有者限定スキン切り替え
- 多言語化（英語、韓国語）
- 統計グラフのアニメーション・インタラクション

---

*最終更新: 2025-07-30*  
*実装完了度: 75% (Phase 1・2ほぼ完成)*  
*次回更新予定: Phase 2完成後（CardThumbnail拡張完了）*