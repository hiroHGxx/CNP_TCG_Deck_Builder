# CNP TCG Deck Builder — Product Requirements Document (PRD)

*Version 1.2 – 2025‑07‑27*

| Section                 | Owner | Status |
| ----------------------- | ----- | ------ |
| Strategy & Vision       | ヒロ    | ✅      |
| Functional Requirements | ヒロ    | ✅      |
| Reiki Card System       | ヒロ    | 🆕     |
| Integrated UI Design    | ヒロ    | 🆕     |
| Non‑functional          | ヒロ    | ✅      |

---

## 📋 Version 1.2 更新内容

### 🆕 新機能追加
- **レイキカードシステム** - 15枚の色リソース管理機能
- **統合UI設計** - 2カラムレイアウト（Disney Lorcana参考）
- **枚数制限システム** - デッキ構築ルール完全対応

### 🔄 仕様変更
- デッキ構造: メインデッキ50枚 + レイキデッキ15枚
- UI構成: タブ切り替え → 左右分割統合型
- カード追加方式: +ボタンオーバーレイ追加

---

## 1. プロダクト概要

**目的**

> ブラウザだけで動く CNP TCG 専用の *Deck Builder & Match Tracker* を提供し、プレイヤーがカード情報を検索しながら**メインデッキ（50枚）+ レイキデッキ（15枚）**を構築し、試合結果を記録して戦績を可視化できるようにする。

**コア価値**

1. **ワンストップ** – カード検索・メイン/レイキデッキ編成・戦績管理を一画面で。
2. **完全ルール対応** – CNP TCGの正式ルール（50+15枚、色均衡）に完全準拠。
3. **直感的操作** – 統合UIで検索→追加→調整の流れを中断なく実行。
4. **オフライン対応** – PWA とローカルキャッシュで大会会場でも快適利用。

---

## 2. スコープ

### 2.1 MVP 機能

- **カードデータベース**
  - JSON + 画像 (Supabase CDN) を事前ビルドでバンドル
  - Fuzzy 検索 (Fuse.js)／色・コスト・種族・レアリティフィルタ
  - 116枚のユニット・イベントカード完全対応

- **🆕 レイキカードシステム**
  - 15枚のレイキデッキ管理（赤・青・緑・黄の4色）
  - メインデッキの色構成に応じた推奨レイキ配分
  - レイキ不足/過多の警告表示

- **🆕 統合デッキビルダー**
  - 2カラムレイアウト: 左カード検索、右デッキエリア
  - カードクリック or +ボタンでデッキ追加
  - リアルタイム色均衡・コスト分布表示
  - メインデッキ50枚 + レイキデッキ15枚の同時管理

- **カード表示・操作**
  - 枚数バッジ表示（1/4, 2/4形式）
  - +ボタンオーバーレイ（ホバー表示）
  - 制限枚数の視覚的表示（レアリティ別）

- **デッキ管理**
  - ローカル保存 (localStorage) 
  - デッキエクスポート/インポート
  - URL共有機能（base64エンコード）

- **戦績トラッカー**
  - 試合日時・対戦相手名・使用デッキ・勝敗・メモを入力
  - IndexedDB保存・基礎統計表示

- **PWA対応**
  - オフラインアクセス、ホーム画面追加、App Icon

### 2.2 今後の拡張

- クラウド同期 (Supabase Row Level Security)
- QRコードでデッキ共有
- MetaMask連携でNFT所有カード自動フェッチ
- 対戦ログCSV/PDF エクスポート
- レイキ配分自動最適化AI

### 2.3 非スコープ (MVP)

- AIデッキレコメンド（レイキ以外）
- リアルタイム多人数コラボ編集
- 多言語（日本語のみ）

---

## 3. ターゲットユーザー

| Persona     | needs                       | pain‑points           |
| ----------- | --------------------------- | --------------------- |
| **競技プレイヤー** | メイン+レイキの最適配分を素早く検討         | 既存ツールがレイキ対応していない      |
| **新規プレイヤー** | レイキシステムを理解しながらデッキ構築        | 色均衡ルールが複雑で混乱しがち       |
| **大会主催者**   | 参加者のデッキ構成（レイキ含む）を確認したい     | レイキチェックが手動で時間がかかる     |

---

## 4. ユーザーストーリー (MVP)

1. *検索* ― 「赤のユニットカード、BP5000以上」を素早く絞り込む。
2. *メインデッキ構築* ― カードをクリックして50枚になると警告が出る。
3. *🆕 レイキ構築* ― メインデッキの色に応じて適切な配分が提案される。
4. *色均衡確認* ― メイン・レイキの色バランスがリアルタイムで確認できる。
5. *保存・共有* ― ブラウザを閉じてもデッキが残り、URLで友人と共有できる。
6. *戦績入力* ― 大会終了後、対戦結果とメモを30秒以内に記録。

---

## 5. 主要機能詳細

### 5.1 🆕 統合デッキビルダー UI

```
┌─────────────────────────────────────────┬───────────────────┐
│  🔍 検索…[奪取]  色🟢🔴🟡🔵  コスト0‑9     │ デッキ 32/50      │
│  フィルタ: レア度 ▼  種族 ▼               │ レイキ 12/15      │
├─────────────────────────────────────────┤                   │
│  Card Grid (lazy‑load, 3×5)                   │ 色均衡            │
│                                               │ 🟢10 🔴8 🟡7 🔵7  │
│  ┌─────────────┐  ┌─────────────┐        │                   │
│  │  📄 image     │  │  📄 image     │        │ ▼メインデッキ        │
│  │      +        │  │      +        │        │ ┌───┐×3 リーリー    │
│  │ 2/4 ⓘ        │  │ 1/2 ⓘ        │        │ ┌───┐×2 ブレイズ    │
│  └─────────────┘  └─────────────┘        │ ┌───┐×1 マカミ      │
│                                               │                   │
│  ┌─────────────┐  ┌─────────────┐        │ ▼レイキデッキ        │
│  │  📄 image     │  │  📄 image     │        │ 🟢🟢🟢🟢🟢         │
│  │      +        │  │      +        │        │ 🔴🔴🔴🔴         │
│  │ 0/4 ⓘ        │  │ 1/4 ⓘ        │        │ 🟡🟡🟡           │
│  └─────────────┘  └─────────────┘        │                   │
│                                               │ CLEAR  EXPORT     │
└─────────────────────────────────────────┴───────────────────┘
```

### 5.2 🆕 レイキカードシステム

#### レイキデッキ管理
- **構成**: 赤・青・緑・黄の基本レイキカード15枚
- **制限**: 各色最大15枚（単色デッキも可能）
- **推奨配分**: メインデッキの色比率に基づく自動提案

#### レイキUIコンポーネント
```
┌─────────────────────────────────┐
│ レイキデッキ 12/15               │
├─────────────────────────────────┤
│ 配分調整                         │
│ 🔴 [−] 4 [+]  🔵 [−] 3 [+]    │
│ 🟢 [−] 3 [+]  🟡 [−] 2 [+]    │
├─────────────────────────────────┤
│ 推奨配分 (メインデッキ比率)         │
│ 🔴5 🔵4 🟢3 🟡3 → 自動適用      │
└─────────────────────────────────┘
```

### 5.3 カード表示機能

#### CardThumbnail改良
- **枚数バッジ**: `2/4` 形式で右下表示
- **+ボタンオーバーレイ**: ホバー時に中央表示
- **制限表示**: レアリティ別上限の視覚化
- **デッキ内表示**: 追加済みカードのハイライト

#### デッキエリア
- **メイン/レイキ分離**: セクション別表示
- **小サムネイル**: 64×90px、縦スクロール
- **統計リアルタイム更新**: 色・コスト・種族分布

### 5.4 🆕 コンポーネント一覧

| Component           | 役割                        | 🆕変更点 |
| ------------------- | ------------------------- | ------- |
| `<IntegratedLayout>` | 2カラム統合レイアウト              | NEW     |
| `<ReikiManager>`    | レイキデッキ管理・配分調整            | NEW     |
| `<DeckStatistics>`  | メイン+レイキ統計表示             | NEW     |
| `<FilterBar>`       | 検索Input・色/コスト/種族フィルタ     | 拡張     |
| `<CardGrid>`        | 116枚をlazy-load表示          | UI改良   |
| `<CardThumbnail>`   | 画像+メタ+枚数バッジ+追加ボタン        | 大幅改良  |
| `<DeckPanel>`       | メイン+レイキ統合表示             | 再設計   |
| `useDeck()`         | Zustand。メイン+レイキ管理       | 拡張     |
| `useReiki()`        | レイキ専用状態管理                | NEW     |

### 5.5 技術採用

- **フレームワーク**: Vite + React + TypeScript + Tailwind CSS
- **状態管理**: Zustand（メイン・レイキ分離管理）
- **画像**: Supabase CDN、256×356 WebP & `loading="lazy"`
- **PWA**: workbox injectManifest でオフライン対応
- **レイアウト**: CSS Grid + Flexbox

---

## 6. 非機能要件

| 区分           | 要件                            | 指標                   |
| ------------ | ----------------------------- | -------------------- |
| **パフォーマンス**  | LCP < 2.5s (4G), JS < 200kB   | Lighthouse 90+       |
| **オフライン**    | 検索/デッキ編集/戦績登録が全て機能            | PWA audits PASS      |
| **アクセシビリティ** | WCAG 2.1 AA                   | Lighthouse A11y > 90 |
| **セキュリティ**   | XSS/CSRF対策 (DOMPurify)       | OWASP ZAP Medium 0   |
| **レスポンシブ**   | 320px～1920px対応             | 全デバイス完全対応        |

---

## 7. 測定指標 (Success Metrics)

| KPI                | 目標 (90日) | 🆕追加指標 |
| ------------------ | --------- | --------- |
| MAU                | 500+      |           |
| デッキ作成完了率（メイン+レイキ） | 75%       | 🆕        |
| レイキ配分最適化利用率      | 60%       | 🆕        |
| 戦績入力継続率（3回以上）     | 40%       |           |
| 平均LCP             | < 2s      |           |

---

## 8. 依存 & リスク

- 公式カード画像CDNの利用許諾/帯域制限
- レイキカードの仕様変更リスク（ゲームルール更新）
- 大会環境の電波状況 → オフラインPWAでカバー
- **🆕 新リスク**: レイキ機能の複雑性によるUX低下

---

## 9. 🆕 実装タイムライン v1.2

| Phase                | 期間  | Deliverable                | 🆕変更点 |
| -------------------- | --- | -------------------------- | ------- |
| **レイキ基盤実装**        | 2d  | ReikiCard型・ストア・基本UI   | NEW     |
| **統合UIリデザイン**       | 3d  | 2カラムレイアウト・コンポーネント再設計 | NEW     |
| **デッキ管理機能拡張**      | 2d  | メイン+レイキ統合バリデーション    | 拡張     |
| **PWA + QA**         | 2d  | Lighthouse 90+/Offline OK | 同様     |
| **公開**               | 1d  | Vercel Deploy + ドメイン    | 同様     |

---

## 10. 🆕 技術仕様要件

### データ構造拡張
```typescript
interface Deck {
  name: string
  mainCards: DeckCard[]     // 50枚のメインデッキ
  reikiCards: ReikiCard[]   // 15枚のレイキデッキ
  colorBalance: ColorStats  // メイン+レイキ統合統計
}

interface ReikiCard {
  color: 'red' | 'blue' | 'green' | 'yellow'
  count: number
}
```

### バリデーションルール
- メインデッキ: 50枚厳守、同名カード制限（レアリティ別）
- レイキデッキ: 15枚厳守、4色自由配分
- 色均衡: メインデッキ色に対応するレイキ推奨

---

## 11. 未解決事項 / 今後検討

- レギュレーション変更（枚数制限）への動的対応
- レイキ配分AI最適化アルゴリズム
- NFT所有者限定スキン切り替え
- 多言語化（英語、韓国語）
- 🆕 レイキカード追加時の後方互換性

---

*最終更新: 2025-07-27*  
*次回更新予定: レイキ機能実装完了後*